package com.github.ordom.remapper.mapping.tsrg

import com.github.ordom.remapper.VERSION
import net.fabricmc.mapping.reader.v2.MappingGetter
import net.fabricmc.mapping.reader.v2.TinyMetadata
import net.fabricmc.mapping.reader.v2.TinyVisitor
import net.fabricmc.mapping.tree.*

class TsrgTree: TinyTree {
    var from: String = ""
    var to: String = ""
    internal var metadata: TinyMetadata = TSRG2TINY_METADATA
    internal val map: MutableMap<String, ClassDef> = mutableMapOf()
    internal val classes = mutableListOf<ClassDef>()
    override fun getMetadata() = metadata
    override fun getDefaultNamespaceClassMap(): MutableMap<String, ClassDef> = map
    override fun getClasses(): MutableCollection<ClassDef> = classes
    open class MappedImpl(
        obfuscated: String,
        srg: String,
        val namespaceMapping: (String) -> Int = TSRG2TINY_METADATA::index
    ): Mapped {
        private val names: Array<String> = arrayOf(obfuscated, srg)
        override fun getName(namespace: String) = names[namespaceMapping(namespace)]
        override fun getRawName(namespace: String) = getName(namespace)
        override fun getComment() = "Generated by OrdomalRemapper v$VERSION"
    }

    class ClassImpl(obfuscated: String, srg: String, namespaceMapping: (String) -> Int = TSRG2TINY_METADATA::index): MappedImpl(obfuscated, srg, namespaceMapping), ClassDef {
        @JvmField
        internal val methods = mutableListOf<MethodDef>()
        @JvmField
        internal val fields = mutableListOf<FieldDef>()
        override fun getMethods(): MutableCollection<MethodDef> = methods
        override fun getFields(): MutableCollection<FieldDef> = fields
    }

    open class DescriptoredImpl(obfuscated: String, srg: String, private val obfuscatedSignature: String?, private val translator: SignatureTranslator, namespaceMapping: (String) -> Int = TSRG2TINY_METADATA::index): MappedImpl(obfuscated, srg, namespaceMapping),
        Descriptored {
        override fun getDescriptor(namespace: String) = if (namespaceMapping(namespace) == 0 || obfuscatedSignature == null) obfuscatedSignature else translator.translate(obfuscatedSignature, namespace)
    }

    class MethodImpl(obfuscated: String, srg: String, descriptor: String?, translator: SignatureTranslator, namespaceMapping: (String) -> Int = TSRG2TINY_METADATA::index):
        DescriptoredImpl(obfuscated, srg, descriptor, translator, namespaceMapping), MethodDef {
        @JvmField
        internal val parameters = mutableListOf<ParameterDef>()
        @JvmField
        internal val localVariables = mutableListOf<LocalVariableDef>()
        override fun getParameters(): MutableCollection<ParameterDef> = parameters
        override fun getLocalVariables(): MutableCollection<LocalVariableDef> = localVariables
    }

    class FieldImpl(obfuscated: String, srg: String, descriptor: String?, translator: SignatureTranslator, namespaceMapping: (String) -> Int = TSRG2TINY_METADATA::index):
        DescriptoredImpl(obfuscated, srg, descriptor, translator, namespaceMapping),
        FieldDef

    class ParameterImpl(obfuscated: String, srg: String, descriptor: String?, private val localVariableIndex: Int,
                        translator: SignatureTranslator, namespaceMapping: (String) -> Int = TSRG2TINY_METADATA::index):
        DescriptoredImpl(obfuscated, srg, descriptor, translator, namespaceMapping),
        ParameterDef {
        override fun getLocalVariableIndex() = localVariableIndex
    }

    class TsrgTreeVisitor(
        private val tree: TsrgTree
    ): TinyVisitor {
        val translator = SignatureTranslator(tree)
        override fun start(metadata: TinyMetadata) {
            tree.metadata = metadata
        }
        override fun pushClass(name: MappingGetter) {
            val cls = ClassImpl(name[0], name[1])
            tree.map[name[0]] = cls
            tree.classes.add(cls)
        }

        override fun pushField(name: MappingGetter, descriptor: String?) {
            val cls = tree.classes.last()
            cls.fields.add(FieldImpl(name[0], name[1], descriptor, translator))
        }

        override fun pushMethod(name: MappingGetter, descriptor: String?) {
            val cls = tree.classes.last()
            cls.methods.add(MethodImpl(name[0], name[1], descriptor, translator))
        }
    }
}